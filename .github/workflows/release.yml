name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Tag identifying the release (e.g. v1.2.3)'
        required: true

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || github.event.inputs.release_tag || github.ref_name }}
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Set Release Version Env
      run: |
        if [[ -z "$RELEASE_TAG" ]]; then
          echo "Release tag is required" >&2
          exit 1
        fi
        echo "VERSION=${RELEASE_TAG#v}" >> $GITHUB_ENV

    - name: Set Maintainer Env
      run: |
        echo "MAINTAINER_NAME=${{ github.actor }}" >> $GITHUB_ENV
        echo "MAINTAINER_EMAIL=${{ github.actor }}@users.noreply.github.com" >> $GITHUB_ENV

    - name: Build Rust binary
      run: cargo build --release --workspace

    - name: Prepare staging directory for packaging
      run: |
        mkdir -p staging/usr/bin
        cp target/release/kubetile staging/usr/bin/
        mkdir -p staging/usr/share/doc/kubetile
        cp README.md staging/usr/share/doc/kubetile/README
        mkdir -p staging/usr/share/licenses/kubetile
        cp LICENSE staging/usr/share/licenses/kubetile/

    - name: Build .tar.gz archive
      run: tar -czvf kubetile-${RELEASE_TAG}-x86_64-unknown-linux-gnu.tar.gz -C staging .

    - name: Build .deb package
      run: |
        cargo install cargo-deb
        cargo deb --no-build --manifest-path crates/kubetile-app/Cargo.toml --output kubetile_${{ env.VERSION }}_amd64.deb

    - name: Build .rpm package
      run: |
        sudo apt-get update && sudo apt-get install -y ruby-dev
        sudo gem install fpm
        fpm -s dir -t rpm -n kubetile -v ${{ env.VERSION }} \
          --description "A terminal-based Kubernetes workspace" \
          --maintainer "${{ env.MAINTAINER_NAME }} <${{ env.MAINTAINER_EMAIL }}>" \
          --license "MIT" \
          -C staging .

    - name: Create GitHub Release and Upload Artifacts
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.RELEASE_TAG }}
        name: "Release ${{ env.RELEASE_TAG }}"
        generate_release_notes: true
        files: |
          *.tar.gz
          *.deb
          *.rpm

  build-macos:
    name: Build macOS (aarch64)
    runs-on: macos-latest
    needs: release
    env:
      RELEASE_TAG: ${{ github.event.release.tag_name || github.event.inputs.release_tag || github.ref_name }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Ensure GitHub CLI
      run: |
        if ! command -v gh >/dev/null; then
          brew install gh
        fi

    - name: Add macOS target
      run: rustup target add aarch64-apple-darwin

    - name: Build release for macOS
      run: cargo build --release --workspace --target aarch64-apple-darwin

    - name: Package mac artifact
      run: |
        mkdir -p macos-artifact/usr/local/bin
        cp target/aarch64-apple-darwin/release/kubetile macos-artifact/usr/local/bin/
        mkdir -p macos-artifact/usr/local/share/doc/kubetile
        cp README.md macos-artifact/usr/local/share/doc/kubetile/README
        mkdir -p macos-artifact/usr/local/share/licenses/kubetile
        cp LICENSE macos-artifact/usr/local/share/licenses/kubetile/
        tar -czvf kubetile-${RELEASE_TAG}-aarch64-apple-darwin.tar.gz -C macos-artifact .

    - name: Upload mac artifact
      run: gh release upload "${RELEASE_TAG}" "kubetile-${RELEASE_TAG}-aarch64-apple-darwin.tar.gz" --clobber
